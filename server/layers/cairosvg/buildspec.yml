version: 0.2

phases:
  install:
    commands:
      - yum update -y
      - yum install -y python3 python3-pip gcc cairo-devel pango-devel gdk-pixbuf2-devel zip
      - pip3 install --upgrade pip

  pre_build:
    commands:
      - pip3 install cairosvg -t /opt/python/lib/python3.10/site-packages/

  build:
    commands:
      - mkdir -p /opt/lib
      # Copy primary libraries
      - cp /usr/lib64/libcairo.so.2 /opt/lib/
      - cp /usr/lib64/libpango-1.0.so.0 /opt/lib/
      - cp /usr/lib64/libpangocairo-1.0.so.0 /opt/lib/
      - cp /usr/lib64/libgdk_pixbuf-2.0.so.0 /opt/lib/
      - find / -name libpng16.so.16 -exec cp {} /opt/lib/ \; -quit
      # Copy identified dependencies
      - cp /usr/lib64/libpixman-1.so.0 /opt/lib/
      - cp /usr/lib64/libfontconfig.so.1 /opt/lib/
      - cp /usr/lib64/libfreetype.so.6 /opt/lib/
      - cp /usr/lib64/libEGL.so.1 /opt/lib/
      - cp /usr/lib64/libpng15.so.15 /opt/lib/
      - cp /usr/lib64/libxcb-shm.so.0 /opt/lib/
      - cp /usr/lib64/libxcb.so.1 /opt/lib/
      - cp /usr/lib64/libxcb-render.so.0 /opt/lib/
      - cp /usr/lib64/libXrender.so.1 /opt/lib/
      - cp /usr/lib64/libX11.so.6 /opt/lib/
      - cp /usr/lib64/libXext.so.6 /opt/lib/
      - cp /usr/lib64/libz.so.1 /opt/lib/
      - cp /usr/lib64/libGL.so.1 /opt/lib/
      - cp /usr/lib64/librt.so.1 /opt/lib/
      - cp /usr/lib64/libm.so.6 /opt/lib/
      - cp /usr/lib64/libc.so.6 /opt/lib/
      - cp /usr/lib64/libpthread.so.0 /opt/lib/
      - cp /usr/lib64/libdl.so.2 /opt/lib/
      - cp /usr/lib64/libgobject-2.0.so.0 /opt/lib/
      - cp /usr/lib64/libglib-2.0.so.0 /opt/lib/
      - cp /usr/lib64/libthai.so.0 /opt/lib/
      - cp /usr/lib64/libfribidi.so.0 /opt/lib/
      - cp /usr/lib64/libpcre.so.1 /opt/lib/
      - cp /usr/lib64/libffi.so.6 /opt/lib/
      - cp /usr/lib64/libexpat.so.1 /opt/lib/
      - cp /usr/lib64/libuuid.so.1 /opt/lib/
      - cp /usr/lib64/libbz2.so.1 /opt/lib/
      - cp /usr/lib64/libGLdispatch.so.0 /opt/lib/
      - cp /usr/lib64/libXau.so.6 /opt/lib/
      - cp /usr/lib64/libGLX.so.0 /opt/lib/
      # Prepare for the ZIP creation
      - chmod -R 755 /opt
      - cd /
      - zip -r /cairosvg_layer.zip opt

  post_build:
    commands:
      - echo "Uploading the Lambda layer zip to S3..."
      - aws s3 cp /cairosvg_layer.zip s3://draft-lambda-layers/cairosvg/
